intra-flow loss recoveri and control for volp hen sanneck gmd foku nguyen tuong long le gmd foku kaiserin-augusta-alle 31 kaiserin-augusta-alle 31 d-l 0589 berlin, germani d-l 0589 berlin, germani sanneck@foku.gmd.de le@foku.gmd.de adam wolisz technic univers berlin, telecommun network group, sekr. ft 5-2 einsteinuf 25 d-l 0587 berlin, germani wolisz@ee.tu-berlin.de abstract best effort packet-switch network, like the internet, do not offer a reliabl transmiss of packet to applic with real-time constraint such as voic. thu, the loss of packet impair the applic-level util. for voic thi util impair is twofold: on on hand, even short burst of lost packet mai decreas significantli the abil of the receiv to conceal the packet loss and the speech signal  playout is interrupt. on the other hand, some packet mai be particular sensit to loss as thei carri more import inform in term of user percept than other packet. we first develop an end-to-end model base on loss  runlength with which we can describ the loss distribut within a flow. these packet-level metric ar then link to user-level object speech qualiti metric. us thi  framework, we find that for low-compress sampl-base codec (pcm) with loss conceal isol packet loss can be conceal well, wherea burst loss have a higher perceptu impact. for high-compress frame-base codec (g.729) on on hand the impact of loss is amplifi through error propag caus by the decod filter memori, though on the other hand such code scheme help to perform loss conceal by extrapol of decod state. contrari to sampl-base codec we show that the conceal  perform mai break at transit within the speech signal howev. we then propos mechan which differenti between packet within a voic data flow to minim the impact of packet loss. we design these method as intra-flow loss recoveri and control. at the end-to-end level, identif of packet sensit to loss (sender) as well as loss  conceal (receiv) take place. hop-by-hop support scheme then allow to (statist) trade the loss of on packet, which is consid more import, against anoth on of the same flow which is of lower import. as both  packet requir the same cost in term of network transmiss, a gain in user percept is obtain. we show that  signific speech qualiti improv can be achiev and addit data and delai overhead can be avoid while still maintain a network servic which is virtual  ident to best effort in the long term. categori and subject descriptor c.2.4 [comput commun network]:  distribut system-distribut applic; (3.2.6 [comput commun network]: internetwork-router; c.4 [comput system organ]: perform of system-itjeasun3nent techniqu; c.4 [comput  system organ]: perform of system--model techniqu gener term design, measur, perform, reliabl 1. introduct consid that a real-time flow mai experi some packet loss, the impact of loss mai vari significantli depend on which packet ar lost within a flow. in the follow we distinguish two reason for such a variabl loss sensit: tempor sensit: loss of adu" which is  correl in time mai lead to disrupt in the servic. note that thi effect is further aggrav by some  interdepend between adu (i.e., that on adu can onli be decod when a previou adu befor ha  successfulli been receiv and decod). for voic, as a singl packet contain typic sever adu (voic frame) thi effect is thu more signific than e.g. for video. it translat basic to isol packet loss versu loss that occur in burst. sensit due to adu heterogen: certain adu might contain part of the encod signal which ar ‘applic data unit: the unit of data emit by a sourc coder such as a video or voic frame. 441 figur 1: schemat util function depend on the loss of more (+l) and less (-1) import packet more import with regard to user percept than other of the same flow. let us consid a flow with two frame type of larg differ perceptu  import (we assum same size, frequenc and no  interdepend between the frame). under the loss of 50% of the packet, the perceptu qualiti vari huge between the case where the 50% of the frame with high perceptu import ar receiv and the tax where the 50% less import frame ar receiv. network support for real-time multimedia flow can on on hand aim at offer a lossless servic, which, howev, to be implement within a pa&et-switch network, will be costli for the network provid and thu for the user. on the other hand, within a lossi servic, the abov sensit constraint must be taken into account. it is our strong belief that thi need to be done in a gener wai, i.e., no applic-specif knowledg (about particular code scheme e.g.) should be necessari within the network and, vice versa, no knowledg about network specif should be necessari within an applic. let us now consid the case that 50% of packet of a flow ar identifi as more import (design by +l) or less import (-1) due to ani of the abov sensit constraint. figur 1 a) show a gener util function describ the  applicationlevel qualiti of servic (qo) depend on the percentag of packet lost. for real-time multimedia traffic, such  util should correspond to perceiv video/voic qualiti. if the rel import of the packet is not known by the transmiss system, the loss rate for the +l and -1  packet ar equal. due to the over-proport sensit of the +l packet to loss as well as the depend of the end-t* end loss recoveri perform on the fl packet, the util function is decreas significantli in a non-linear wai  (approxim in the figur by piec-wise linear function) with an increas loss rate. figur 1 b) present the cb~ where all +l packet ar protect at the expens of -1 pa&&. the decai of the util function (for loss rate < 50%) is reduc, becaus the +l packet ar protect and the  endto-end loss recoveri can thu oper properli over a wider rang of loss rate indic by the shade area. thi result in a grace degrad of the applic"s util. note that the higher the non-linear of the util contribut of the fl packet is (deviat from the dot curv in fig. 1 a), the higher is the potenti gain in util when the protect for +l packet is enabl. result for actual  perceiv qualiti as util for multimedia applic exhibit such a non-linear behavior*. to describ thi effect and provid a taxonomi for  differ qo enhanc approach, we introduc a novel  terminolog: we design mechan which influenc qo paramet between bow (thu decreas the loss rate of on flow at the expens of other flow) as inter-flow qo. scheme which, in the presenc of loss, differenti between pa&& within a flow as demonstr in figur 1 abov, provid intra-flow qo enhanc. as qo mechan have to be implement within the network (hopbi-hop) and/or in the end system (end-to-end), we have anoth axi of classif. the adapt of the sender"s bitrat to the current  network congest state as an intraflow qo scheme (loss avoid, [is]) is difficult to appli to voic. consid that voic flow have a veri low bitrat, the rel cost of transmit the feedback inform is high (when  compar e.g. to a video flow). to reduc thi cost the feedback interv would need to be increas, then lead to a higher probabl of wrong adapt decis. the major  di6culti, howev, is the lack of a codec which is truli scalabl in term of it output bitrat and correspond perceptu qualiti. current standard voic codec ([17]) usual onli have a 6xed output bitrat. while it ha been propos to switch between voic codeca ([2]), the mo (subject qualiti) valu for the codec emploi do not differ much: e.g., theitu codec g.723.1, g.729, g.728, g.726and g.711 cover a bitrat rang from 5.3 kbitj to 64 kbitj while the subject qualiti differ by less than 0.25 on a l-to-5 mo scale ([4], 1: bad, 5: excel qualiti). so when the  avail of suttici comput power is assum, the lowest bitrat codec can be chosen perman without actual decreas the perceptu qualiti. for loss recoveri on an end-to-end basi, due to the  realtim delai constraint, open-loop scheme like forward  error correct (fec) have been propos ([2]). while such scheme ar attract becaus thei can be us on the  internet todai, thei also have sever drawback. the amount of redund inform need to be adapt to avoid  take bandwidth awai from other flow. thi adapt is crucial especi when the fraction of traflic us  redund scheme is larg (181). if the redund is a sourc code itself, like it ha often been propos ([7]), the  comment from abov on adapt also appli. us  redund ha also implic to the playout delai adapt ([lo]) emploi to de-jitter the packet at the receiv. note that the present type of loss sensit also appli to  ap‘while we have obtain result which confirm the shape of the overal util curv shown in fig. 1, clearli the util function of the +1/-l sub.flow and their relationship ar more complex and onli approxim addit. 442 tabl 1: state and transit probabl comput for an end-to-end internet trace us a gener markov model (third order) by yajnik et. al. [9] state 000 001 010 011 100 101 110 111 probabl of probabl probabl be in the state of i(s)=0 of l(s)=1 0.8721 0 . 9 7 7 9 0.0221 0 . 0 2 0 8 0 . 6 1 1 2 0 . 3 8 8 8 0 . 0 1 4 2 0 . 8 8 1 9 0.1181 0 . 0 1 0 2 0 . 2 7 1 0 0 . 7 2 9 0 0 . 0 2 0 8 0 . 9 2 7 8 0 . 0 7 2 2 0 . 0 0 3 6 0 . 4 1 9 8 0 . 5 8 0 2 0 . 0 1 0 2 0 . 8 1 0 9 0.1891 0.0481 0 . 1 5 3 9 0.8461 plicat which ar enhanc by end-to-end loss recoveri mechan. end-to-end mechan can reduc and shift such sensit but cannot come close to elimin them. therefor in thi work we assum that the lowest possibl  bitrat which provid the desir qualiti is chosen. neither feedback/adapt nor redund is us, howev, at the end-to-end level, identif/mark of packet  sensit to loss (sender) as well as loss conceal (receiv) take place. hop-by-hop support scheme then allow trade the loss of on packet, which is consid more import, against anoth on of the same flow which is of lower  import. we emploi actual codec and measur their util in the presenc of packet loss us object speech qualiti measur. the paper is structur as follow: section 2 introduc packet- and user-level metric. we emploi these metric to describ the sensit of voip traffic to packet loss in section 3. section 4 briefli introduc a queue manag algorithm which can be us for intra-flow loss control. in section 5, we present result document the perform of the propos mechan at both the end-to-end and  hopbi-hop level. section 6 conclud the paper. 2. metric 2.1 packet-level metric a gener markov model ([19, s]) which describ the loss process is defin as follow: let p( z(s) ] z(s - m),... ,z(s - 2),z(s - 1) ) be the state transit probabl of a gener markov model of order m, where z(s) is the loss indic function for the packet with the sequenc number s. all combin for the valu (0 and 1) of the sequenc z(s-m), . . . , z(s-2),z(s-1) appear in the state space. as an exampl p( z(s) = 1 ] z(s -  2),z(s1) = 01 ) give the state transit probabl when the current packet s is lost, the previou packet s - 1 ha also been lost and packet s - 2 ha not been lost. the number of state of the model is 2. two state transit can take place from ani of the state. thu, the number of paramet which have to be comput is 2m+1. even for rel small m thi amount of paramet is difficult to be evalu and compar. tabl 1 show some valu for the state and transit probabl for a gener markov model of third order measur end-to-end in the internet by yajnik et. al. ([19]). it is interest to note that for all state with z(s - 1) = 0 the probabl for the next packet not to be lost (z(s) = 0) is gener veri high (> 0.8, in bold typefac) wherea when z(s- 1) = 1 the state transit probabl to that event cover the rang of 0.15 to 0.61. that mean that past no loss event do not affect the loss process as much as past loss event. intuit thi seem to make sens, becaus a successfulli arriv packet can be seen as a indic for congest relief. andren et. al. ([l]) as well as yajnik et. al. ([20]) both confirm thi by measur the cross correl of the loss- and  no-loss-runlength. thei came to the result that such correl is veri weak. thi impli that pattern of short loss burst interspers with short period of success packet arriv occur rare (note in thi context that in ‘&abl 1 the pattern 101 ha by far the lowest state probabl). thu, in the follow we emploi a model ([12]) which onli consid the past loss event for the state transit  probabl. the number of state of the model can be reduc from 2m to m + 1. thi mean that we onli consid the state transit probabl p( z(s) ] z(s - k), . . . ,z(s - 1) ) with z(s - ic + i) = 1 v i e [0, ic - 11, where ic (0 < k 5 m) is a variabl paramet. we defin a loss run length lc for a sequenc of ic consecut lost packet detect at sj (sj > ic > 0) with z(sj - k - 1) = o,z(sj) = 0 and z(sj - k + i) = 1 v i e [0, ic - 11, j be the j-th ‘<burst loss event. note that the paramet of the model becom independ of the sequenc number s and can now rather be describ by the occur ok of a loss run length k. we defin the random variabl x as follow: x = 0: no packet lost, x = k (0 < lc < m): ezactli lc consecut packet lost, and x 2 k (0 < k < m): at least k  consecut packet lost. with thi definit, we establish a loss run-length model with a finit number of state (m + 1) which give loss probabl depend on the burst length. in the model, for everi addit lost packet which add to the length of a loss burst a state transit take place. if a packet is successfulli receiv, the state return to x = 0. thu, the state probabl of the system for 0 < ic < m is p(x 2 zc). due to the limit memori of the system, the last state x = m is just defin as crm consecut packet lost, with p(x = m) be the state probabl. given the case of a finit number of packet a for a flow, which experi d = cpc1 ]cok packet drop, we have the  rel frequenc pl,k = 2 (p(x = k) for a + 00) for the occur of a loss burst of length lc. an approxim for the expect of the random variabl x can be comput as pi = cr==, #+l,k and identifi with the mean loss rate. we can also approxim the state probabl of the model by the cumul loss rate p~,~,,~(k) = crskp~,,, (0 < k < m) and p~,~ = cr.p=, (n--mzl)ot (k = m). the transit probabl for 1 < lc < m can be comput easili as: p(k--l)(k) = p(x>klx>k-l)= p(x>knx>k-1) p(x>k-1) zz p ( x > k ) p(x>k-1) these condit loss probabl again can be  approxpzl,cum(k) _ cnm,k on i m a t e d by pl,cond@) = pl,cum(k-l) - c;ek--l 0,. for 443 figur 2: loss run-length model with m + 1 state p(x = m]x = m) we have: pl,,,d(rn) = %lf;:p fig. 2 show the markov chain for the model. (1) addition, we also defin a random variabl y which de scribe the distribut of burst loss length with respect to the bunt loss event j (and not to packet event like in the definit of x). we have the burst loss length rate ga = * as an estim for p(y = k). thu, the mean burst loss length is g = h = e = ct==, kgb correspond to e[y] (averag loss gap, [5]). the run-length model impli a geometr distribut for resid in state x = m. for the probabl of a burst loss length of k packet we thu can comput estim for  perform paramet in a higher order model represent (note that here y repres the random variabl us in the higher-order model). for a three state model we have e.g. for p(y = k): p(y = k) = p(y=k)=l-pm: k=l pn p;;" (1 -pm): k 2 2 c-4 for the special case of a system with a memori of onli the previou packet (m = l), we can us the runlength  distribut for a simpl comput of the paramet of the commonli-us gilbert model (fig. 3) to character the loss process (x be the associ random variabl with x = 0: no packet lost, x = 1 a packet lost). then the probabl of be in state m can be seen bs the uncow dition loss probabl ulp and approxim by the mean loss (pr. = pi,,,,). onli on condit loss probabl clp for the transit 1 --t 1 exist: p~,e-d = cfl(~ -  lbd (3) if loss of on flow ar correl (i.e., the loss  probabl of an arriv packet is itiuenc by the contribut to the state of the queue by a previou packet of the same flow and/or both the previou and the current packet see busti arriv of other traffic, [15]) we have pal < clp and thu ulp 5 clp. for pal = elp the gilbert model is  equival to a l-state (bernotilli) model with zllp = elp (no loss correl). as in equat 2 we can comput an estim for the  probabl of a burst loss length of k packet for a higher order model represent: b(y = k) = clpk-‘(1 - clp) (4) figur 3: loss run-length (gilbert model) model with two state figur 4: compon of the end-to-end loss  recoveri/control measur setup. 2.2 object speech qualiti metric unlik the convent method like the signal-t-nois  ratio (snr), novel object qualiti measur attempt to  estim the subject qualiti as close as possibl by  model the human auditori system. in our evalu we us two object qualiti measur: the enhanc mod&d bark spectral distort (embsd, [21]) and the measw ing normal block (mnb) describ in the appendix ii of the itu-t recommend p.861 ([18]). these two object qualiti measur.~ ar report to have a veri high correl with subject test, their relat to the rang of subject test result valu (mo) is close to be linear and thei ar recommend as be suitabl for the  evalu of speech degrad by transmiss error in real  network environ such as bit error and frame erasur ([18, 211). both metric ar distanc measur, i.e., a ib suit valu of 0 impli perfect qualiti, the larger the valu, the wors the speech qualiti is (in fig. 5 we show an axi with approxim correspond mo valu). for all  simul in thi paper we emploi both scheme. as thei yield veri similar result (though mnb result gener exhibit less variabl) we onli present embsd result. 3. voip loss sensit figur 4 show the compon of the measur setup which we will us to evalu our approach to combin end-t-end and hopbi-hop loss recoveri and control. the 444 shade box show the compon in the data path where mechan of loss recoveri ar locat. togeth with the paramet of the network model (section 2.1) and the  perceptu model we obtain a measur setup which allow us to map a specif pcm signal input to a speech qualiti measur. while us a simpl end-to-end loss  character, we gener a larg number of loss pattern by us differ seed for the pseudcerandom number gener (for the result present here we us 300 pattern for each  simul condit for a singl speech sampl). thi procedur take thu into account that the impact of loss on an input signal mai not be homogen (i.e., a loss burst within on segment of that signal can have a differ perceptu impact than a loss burst of the same size within anoth segment). by averag the result of the object qualiti measur for sever loss pattern, we have a reliabl indic for the perform of the codec oper under a certain network loss condit. we emploi a gilbert model (fig. 3) as the network model for the simul, as we have found that here higher order model do not provid much addit inform. 3.1 tempor sensit 3.1.1 pa4 we first analyz the behaviour for ~-law pcm flow (64 kbit/s) with and without loss conceal, where the loss conceal repair isol loss onli (speech stationar can onli be assum for small time interv). result ar shown for the ap/c conceal algorithm ([ll]). similar result were obtain with other conceal algorithm. figur 5 show the case without loss conceal enabl where gilbert model paramet ar vari. the result speech qualiti is insensit to the loss distribut  paramet (elp). the result ar even slightli decress for an increas clp, point to a signific variabl of  theresuit. in figur 6 the result with loss conceal ar  depict. when the loss correl (dp) is low, loss  conceal provid a signific perform improv. the rel improv increas with increas loss (pulp). for higher clp valu the case with and without  conceal becom increasingli similar and show the same  perform at clp x 0.3. figur 5 and 6 respect also  contain a curv show the perform under the assumpt of random loss (bernouilli model, ulp = elp). thu,  consid a given ulp, a worst case loss pattern of altern loss (i(s mod 2) = l,l([s + l] mod 2) = 0) would enabl a consider perform improv (with ok = ovk > 1: p~,cond = 0, eq. 3). as we found by visual inspect that the distribut of the perceptu distort valu for on loss condit seem to approxim follow a normal distribut we emploi mean and standard deviat to describ the statist variabl of the measur valu. figur 7 present the perceptu distort as in the previou figur but also give the standard deviat as error bar for the respect loss condit. it show the increas variabl of the result with increas loss correl (clp), while the variabl doe not seem to chang much with an increas amount of loss (alp). on on hand thi point to some, though weak, sensit with regard to heterogen (i.e., it matter which area of the speech signal (voic/unvoic) experi a burst loss). on the other hand it show, that a larg number of differ figur 5: util curv for pcm without loss  conc e a l m e n t (embsd) figur 6: util curv for pcm with loss  conceal (embsd) figur 7: variabl of the perceptu distort with 10s~ conceal (embsd) 445 figur 8: util curv for the g.729 codec  (embsd) loss pattern is necessari for a certain speech sampl when us object speech qualiti measur to assess the impact of loss corwlat on user percept. 3.1.2 g.729 g.729 ([17]) us the conjug structur algebra code excit linear predict (cs-acelp) code scheme and ooerat at 8 kbit/s. in g.729. a speech fmme is 10 ms in d&ion. for each frame, the"g.7i9 encod analyz the input data and extract the paramet of the code excit linear predict (celp) model such as linear predict filter coeffici and excit vector. when a frame is lost or corrupt, the g.729 decod us the paramet of the previou frame to interpol those of the lost frame. the line spectral pair coeffici (lsp3) of the last good frame ar repeat and the gain coeffici ar taken from the previou frame but thei ar damp to gradual reduc their impact. when a frame loss occur, the decod cannot updat it state, result in a diverg of encod and decod state. thu, error ar not onli introduc  dure the time period repres by the current frame but also in the follow on. in addit to the impact of the miss codeword, distort is increas by the miss updat of the predictor filter memori for the line speo tral pair and the linear predict synthesi filter memo ri. figur 8 show that for similar network condit the output qualiti of the g.729* is wors than pcm with loss conceal, demonstr the compress versu qualiti tradeoff under packet loss. interestingli the loss correl (dp paramet) ha some impact on the speech qualiti,  howev, the effect is weak point to a certain robust of the g.729 codec with regard to the resili to consecut packet loss due to the intern loss conceal.  rosenberg ha done a similar experi ([9]), show that the differ between the origin and the conceal signal with increas loss bursti in term of a mean-squar error is signific, howev. thi demonstr the import of perceptu metric which ar abl to includ conceal ‘lsp ar anoth represent of the linear predict coeffici. ‘two g.729 frame ar contain in a packet. figur 9: resynchron time (in frame) of the g.729 decod after the loss of k consecut frame (k e [1,4]) as a function of frame posit. (and not onli reconstruct) oper in the qualiti  assess. 3.2 sensit due to adu heterogen pcm is a memoryless encod. therefor the adu content is onli weakli heterogen (figur 7). thu, in thi  section we concentr on the g.729 coda. the experi we carri out is to meawr the resynchron time of the d* coder after k consecut frame ar lost. the g.729 decod is said to have resynchron with the encod when the  energi of the error signal fall below on percent of the energi of the decod signal without frame loss (thi is equival to a signal-t-nois ratio (snr) threshold of 2odb). the error signal energi (and thu the snr) is comput on a per-frame basi. figur 9 show the resynchron time (express in the number of frame need until the  threshold is exceed) plot against the posit of the loss (i.e., the index of the first lost frame) for d&rent valu of k. the speech sampl is produc by a male speaker where an unvoic/voic (au) transit occur in the eighth frame. we can see from figur 9 that the posit of a frame loss ha a signilic inlluenc cm the result signal degrad", while the degrad is not that sensit to the length of the frame loss burst k. the loss of unvoic frame seem to have a rather small impact on the signal degrad and the decod recov the state inform fast  thereaft. the loss of voic frame caus a larger degrad of the speech signal and the decod need more time to resyncbron with the sender. howev, the loss of voic frame at an unvoic/voic transit lead to a signific degrad of the signal. we have repeat the experi for differ male and femal speaker and obtain similar result. lsking into account the wed code scheme, the abov phenomenon could be explain as follow: becaus voic sound have a higher energi than unvoic sound, the loss of voic frame caus a larger signal degrad than the loss of unvoic frame. howev, due to the  period properti of voic sound, the decod can conceal ‘while on on hand we see that snr n~easu~es often do not correl well with subject speech qualiti, on the other hand the larg differ in the snr-threshold-base resynchron time clearli point to a signific impact on subject speech qualiti. 446 figur 10: differenti red drop probabl as a function of averag queue size the loss of voic frame well onc it ha obtain suflici inform on them. the decod fail to conceal the loss of voic frame at an unvoic/voic transit becaus it attempt to conceal the loss of voic frame us the filter coeffici and the excit for an unvoic sound. moreov, becaus the g.729 encod us a move averag filter to predict the valu of the line spectral pair and onli transmit the differ between the real and predict  vaue, it take a lot of time for the decod to resynchron with the encod onc it ha fail to build the appropri linear predict filter. 4. queue manag for  intraflow loss control while we have highlight the sensit of voip traffic to the distribut of loss in the last section, we now want to briefli introduc a queue manag mechan ([13]) which is abl to enforc the rel prefer of the ap plicat with regard to loss. we consid flow with packet mark with +l and  ‘i1 (as describ in the introduct) bs foreground traffic (ft) and other (best effort) flow as backaound traffic (bt). packet mark, in addit to keep the desir properti of state aggregr within the network core as propos by the ietf differenti servic architectur, is exploit here to convei the intrbflow requir of a llow. as it should be avoid to introduc reorder of the packet of a flow in the network we consid mechan for the manag of a singl queue with differ prioriti level. on approach to realiz inter-flow servic  differenti us a singl queue is rio (‘red with in and out", [3]). with rio, two averag queue size as congest  indic ar comput: on just for the in (high prioriti) packet and anoth for both in and out (low prioriti) packet. packet mark as out ar drop earlier (in term of the averag queue size) than in packet. rio ha been design to decreas the clip seen by particular bow at the expens of other flow. in thi work, howev, we want to keep the ulp as given by other paramet while  modifi the loss distribut for the foreground traffic (ft). thi amount to trade the loss of a +l packet against a -1 packet of the same flow (in a statist sens). fig. 10 show the convent red drop probabl curv (po as a function of the averag queue size for all arriv avg), which is appli to all unmark (0) traffic (background traffic: bt). the necessari relationship between the drop probabl for packet mark as -1 and +l can be deriv 85  follow (note that thi relationship is valid both at the  end-tend level and everi individu hop): let a = a0 + a+, +a-~ be the overal number of emit packet by an ft flow and a,, + e [-l,o, +l] be the number of packet belong to a certain class (where the 0 class correspond to (unmark) best effort traflic). then, with a+, = a-1 = a,~, and  consid that the result servic ha to be best effort in the long term, we have: aopo + a+lp+l + lip-1 a ap qlll@+l fp-1) = (a--oo)m p - l = zpo-p+1 (5) due to thi relationship between the drop probabl for +l and -1 packet, we design thi queue  manag algorithm as differenti red (dier). figur 10 show the correspond drop probabl curv. due to the condit of a+, = (i-l = all, in addit to the  convent red behaviour, the diffr implement should also monitor the +l and -1 arriv process. if the ratio of +l to -1 packet at a gatewai is not 1 (either due to  misbehav flow or a signific number of flow which have alreadi experienc loss at earlier hop) the -1 loss prob abil is decreas and the +l probabl is increas at the same time thu degrad the servic for all user. the shade area abov and below the po(avg) curv (fig. 10) show the oper area when thi correct is ad. in [13] it ha been shown that us onli the convent red averag queue size avg for dsred oper is not suffici. thi is due to the potenti miss  correl of the comput aug valu between consecut +l and -1 arriv, especi when the share of the ft traftic is low. as thi might result in a unfair distribut of loss between the ft and bt fraction, a specif avgl valu is comput by sampl the queue size onli at ft arriv instant. thu, a servic differenti for foreground  traffic is possibl which doe not differ from convent red behaviour in the long term averag (i.e., in the ulp). 5. intra-flow loss recoveri and control 5.1 tempor sensit consid a flow with tempor loss sensit, paragraph 3.1.1 ha shown that a simpl, period loss pattern enhanc the perform of the end-to-end loss recoveri. the pattern is not ti to particular packet, therefor a per-flow  character with the introduc metric is applic. in thi paragraph we assum that a flow express it tempor  se*sitiv by mark it flow with an altern pattern of ,c+l,>,‘c~l,,, 447 figur 11: comparison of actual and estim figur 12: comparison of actual and estim burst loss length rate as a function of burst length burst, loss length rate as a function of burst length k: three state run-length-base model k: two state run-length-base model (gilbert.) figur 11 and 12 show the rate for the actual and the  estim burst loss length for a three-state (m = 2) and a two=state (m = 1, gilbert) model respect6. we can observ that diffr shape the burst probabl curv in the desir wai. most of the probabl mass is  concentr at, isol loss (the ideal behaviour would be the occur of onli isol loss (ic = 1) which can be  express with clp = 0 in term of gilbert model paramet). with drop tail an approxim geometr decreas burst loss probabl with increas burst length (eq. 4) is obtain, where the clp paramet is rel larg though. thu, consid voic with tempor loss  sensit as the foreground traffic of interest, with diffr a larg number of short annoi burst can be trade against a larger number of isol loss and few long loss burst (which occur when the queue is under temporari overload, i.e., awg > maxth, fig. 10). we can see that the three-state model estim (eq. 2)  reflect the two area of the diffr oper (the sharp drop of the burst loss length rate for k = 2 and the decreas along a geometr decreas asymptot for k > 2). thi effect cannot be captur by the two state model (eq. 4) which thu overestim the burst loss length rate for ic = 2 and then huge underestim it for k > 2. interestingli, for drop tail, while both model captur the shape of the  actual curv, the lower order model is more accur in the estim. thi can be explain as follow: if the burst loss length probabl ar in fact close to a geometr  distribut, the estim is more robust if all data is includ (note that the run-length base approxim of the  condit loss probabl p(x = mlx = m) onli includ loss run-length occur larger or equal to m: eq. 1). swe onli discuss the result qualit here to give an exampl how an intra-flow loss control algorithm perform and to show how loss model can captur thi perform. detail on the simul scenario and paramet can be found in [12]. 5.2 sensit due to adu heterogen in paragraph 3.1.2 we have seen that sensit to adu heterogen result in a certain non-period loss pattern. thu, a mechan at (or near) the sender is necessari which deriv that pattern from the voic data.  furthermor, an explicit cooper between end-to-end and hop by-hop mechan is necessari (fig. 4). we us the result of paragraph 3.2 to develop a new packet mark scheme call speech properti-base select  differenti packet mark (spb-diffmark). the  diffmark scheme concentr the higher prioriti packet on the frame essenti to the speech signal and reli on the decod"s conceal for other frame. figur 13 show the simpl algorithm written in a  pseudocod that is us to detect an unvoic/voic (uw)  transit and protect the voic frame at, the begin of a voic signal. the procedur analysi0 is us to classifi a block of ic frame as voic, unvoic, or uv transit. send0 is us to send a block of ic frame as a singl packet with the appropri prioriti (either fl, 0 or -1). as the core algorithm give onli a binari mark decis (protect the packet or not), we emploi a simpl algorithm to send the necessari -1 packet for compens (eq. 5): after a burst of +l packet ha been sent, a correspond number of -1 packet is sent immedi. state about the necessari number of to-be-sent -1 packet is kept in the event that the spb algorithm trigger the next +l burst befor all -1 packet necessari for compens ar sent. thu, seen over time interv which ar long compar to the +1/-l burst time, the mean loss for the flow will be equal to the best effort case (eq. 5). n is a pre-defin valu and defin how mani frame at the begin of a voic signal ar to be protect. our simul (fig. 9) have shown that the rang from 10 to 20 ar appropri valu for n (depend on the network loss condit). in the simul present below, we choos ic = 2, a typic 448 protect = 0 fcm?ach (k frame) classifi = analysi(k frame)] if (protect > 0) if (classifi == unvoic) protect = 0 if (compens > 0) compens = compens-k send(k frame, -1) els send(k frame, 0) endif els send(k frame, +l) protect = protect-k compens = compens+k endif els if (classifi == uvfransit) send(k frame, +l) protect = n - k compens = compens+k els if (compens > 0) compens = compens-k send(k frame, -1) els send(k frame, 0) endif endif endif endfor figur 13: spb-diffmark pseudo code valu for interact speech transmiss over the internet (20ms of audio data per packet). a larger number of ic would help to reduc the rel overhead of the protocol header but also increas the packet delai and make sender classif and receiv conceal in case of packet loss (due to a larger loss gap) more difficult. 5.2.1 en.d-to-end simul descript due to the non-period loss pattern, we need to explicitli associ a drop probabl with a singl packet within an end-to-end model. therefor we us a separ on-state markov model (bernouilli model) to describ the network behaviour as seen by each class of packet. best effort packet (design by 0 in fig. 14) ar drop with the probabl pc, wherea packet mark with +l and -1 ar drop with probabl of p+i and p-1 respect. thi is a reason assumpt" with regard to the  interdepend of the differ class in fact, as it ha been shown that diffr (fig. 11 and 12) achiev a fair amount of decorrel of +l and -1 packet loss. nevertheless to includ some correl between the class we have set p+i = 10m3 pc for the subsequ simul. thi should ‘the appropri of the simpl end-to-end model us ha been investig in [12] with discret event  simul us a multi-hop topolog and detail model of foreground and background traffic sourc. mark scheme network model n o m a r k lolo/ 0~0~0~ 01 f u l l m a r k +i +i +i +i +l +i spb mark 1 0 1+i j +i i 0 i 0 / 0 alt mark o/+11 ol+ll o/+1 +i pcl 330 po s p b d i f f m a r k 1 ij / +l i +l i -1 j-1 / 0 i alt diffmark i-1 / +i 1-1 1+i /-i 1+i 1 figur 14: mark scheme and correspond  network model. also allow a reason evalu of how loss in the fl class affect the perform of the spb-algorithm. for a direct comparison with spb-diffmark, we evalu a scheme where packet ar alternatingli mark as be either -1 or +l (alt-diffmark, figur 14). we  furthermor includ relat inter-flow loss protect scheme. the first scheme us full protect (full mark, all packet ar mark as +l). the spb-mark scheme  oper similarli to spb-diffmark, but no -1 packet ar sent for compens (those packet ar also mark as 0). for comparison we again us a scheme where  packet ar alternatingli mark as be either 0 or +l (alt-mark). final, packet of pure best effort flow ar drop with the probabl po (no mark case in fig. 14). for the spb mark scheme the percentag of +l- and -l-mark packet respect is 40.4% for the speech materi us. we obtain similar mark  percentag for other speech sampl. the alt mark scheme mark exactli 50% of their packet as be fl. 5.2.2 result figur 15 show the perceptu distort for the mark scheme depend on the drop probabl pc. the  unprotect case (no mark) ha the highest perceptu  distort and thu the worst speech qualiti*. the differenti mark scheme (spb-diffmark) offer a significantli better speech qualiti even when onli us a network  servic which amount to best effort in the long term. note that the alt-diffmark mark strategi doe not  differ from the best effort case (which confirm the result of paragraph 3.1.2). spb-diffmark is also even better than the inter-flow qo alt-mark scheme, especi for higher valu of pe. these result valid the strategi of our spb mark scheme that do not equal mark all packet with a higher prioriti but rather protect a subset of frame that ar essenti to the speech qualiti. the spb-fec scheme ([12]), *we have also perfo rmed inform listen test which  confirm the result us the object metric. 449 figur 15: perceptu distort (embsd) for the mark scheme and spb-fec which us redund9 piggyback on the main payload packet (rfc 2198, [7]) to protect a subset of the packet, enabl a veri good output speech qualiti for low loss rate. howev, it should be note that the amount of data sent over the network is increas by 40.4%. note that the  simul presum that thi addition consum bandwidth itself doe not contribut significantli to congest. thi assumpt is onli valid if a small fraction of trafhc is voic ([s]). the spb-fec curv is convex with increas po, as due to the increas loss correl an increas number of consecut packet carri redund ar lost lead to unrecover loss. the curv for spb-diffmark is concav, howev, yield better perform for pe & 0.22. the inter-flow qo alt-mark scheme (50% of the  packet ar mark) enhanc the perceptu qualiti. howev, the auditori distanc and the perceptu distort of the spb-mark scheme (with 40.4% of all packet mark) is significantli lower and veri close to the qualiti of the  decod signal when all packet ar mark (full mark). thi also show that by protect the entir flow onli a minor improv in the perceptu qualiti is obtain. the result for the full mark scheme also show that, while the loss of some of the +l packet ha some  measur impact, the impact on perceptu qualiti can still be consid to be veri low. 6. conclus in thi paper we have character the behaviour of a  samplebas codec (pcm) and a frame-base codec (g.729) in the presenc of packet loss. we have then develop intraflow loss recoveri and control mechan to increas the  perceptu qualiti. while we have test other codec onli  inform, we think that our result reflect the fundament  differ between codec which either encod the speech  wave‘we also us the g.729 encod for the redund sourc code. form directli or which ar base on linear predict. for pcm without loss conceal we have found that it  neither exhibit signific tempor sensit nor sensit to payload heterogen. with loss conceal, howev, the speech qualiti is increas but the amount of increas exhibit strong tempor sensit. frame-base codec amplifi on on hand the impact of loss by error  propag, though on the other hand such code scheme help to perform loss conceal by extrapol of decod state. contrari to sampl-base codec we have shown that the conceal perform of the g.729 decod mai break at transit within the speech signal howev, thu  show strong sensit to payload heterogen. we have briefli introduc a queue manag algorithm which is abl to control loss pattern without chang the amount of loss and character it perform for the loss control of a flow exhibit tempor sensit. then we develop a new packet mark scheme call speech properti-base select differenti packet mark for an effici protect of frame-base codec. the  spbdiffmark scheme concentr the higher prioriti  packet on the frame essenti to the speech signal and reli on the decod"s conceal for other frame. we have also evalu the map of an end-to-end algorithm to  interflow protect. we have found that the select mark scheme perform almost as good as the protect of the  entir flow at a significantli lower number of necessari  highprior packet. thu, combin intra-flow end-to-end / hopbi-hop scheme seem to be well-suit for heavili-load network with a  rel larg fraction of voic traffic. thi is the case becaus thei neither need the addit of redund nor feedback (which would incur addit data and delai overhead) and thu yield stabl voic qualiti also for higher loss rate due to absenc of fec and feedback loss. such scheme can  better accomod codec with fix output bitrat, which ar difficult to integr into fec scheme requir adapt of both the codec and the redund gener. also, it is us for adapt codec run at the lowest possibl bitrat. avoid redund and feedback is also  interest in multicast conferenc scenario where the end-to-end loss characterist of the differ path lead to member of the session ar larg differ. our work ha clearli focus on link simpl end-to-end model which can be easili parametr with the known characterist of  hopbi-hop loss control to user-level metric. an analysi of a larg scale deploy of non-adapt or adapt fec as compar to a deploy of our combin scheme requir clearli further studi. 7. acknowledg we would like to thank wonho yang and robert yantorno, templ univers, for provid the embsd softwar for the object speech qualiti measur. michael  zander, gmd foku, help with the simul of the queue manag scheme. 8. addit author addit author: georg carl (gmd foku, email: carl@foku.gmd.de). 450 9. pi pi [31 pi [51 pi [71 pi pi wi wi w refer j. andren, m. hild, and d. veitch. understand end-to-end internet traffic dynam. in proceed ieee globecom, sydnei, australia, novemb 1998. j.-c. bolot, s. foss-parisi, and d. towslei. adapt fec-base error control for interact audio in the internet. in proceed ieee infocom, new york, ny, march 1999. d. clark and w. fang. explicit alloc of best effort packet deliveri servic. technic report, mit lc, 1997.  http://diffserv.lc.mit.edu/paper/expallot-ddc-wf.pdf. r. cox and p. kroon. low bit-rate speech coder for multimedia commun. ieee commun magazin, page 34-41, decemb 1996. j. ferrandiz and a. lazar. consecut packet loss in real-time packet traffic. in proceed of the fourth intern confer on data commun system, ifip tc6, page 306-324, barcelona, june 1990. w. jiang and h. schulzrinn. qo measur of internet real-time multimedia servic. in proceed nossdav, chapel hill, nc, june 2000. c. perkin, i. kouvela, 0. hodson, m. handlei, and j. bolot. rtp payload for redund audio data. rfc 2198, ietf, septemb 1997. ftp://ftp.ietf.org/rfc/rfc2198.txt. m. podolski, c. romer, and s. mccann. simul of fec-base error control for packet audio on the internet. in proceed ieee infocom, page 48-52, san francisco, ca, march 1998. j. rosenberg. g. 729 error recoveri for internet telephoni. project report, columbia univers, 1997. j. rosenberg, l. qiu, and h. schulzrinn. integr packet fec into adapt voic playout buffer algorithm on the internet. in proceed ieee infocom, tel aviv, israel, march 2000. h. sanneck. conceal of lost speech packet us adapt packet. in proceed ieee multimedia system, page 140-149, austin, tx, june 1998. ftp://ftp.foku.gmd.de/pub/glone/paper/sann9806: adapt.ps.gz. h. sanneck. packet loss recoveri and control for voic tinsmiss over the internet. phd thesi, gmd foku / telecommun network group, technic univers of berlin, octob 2000. p31 pi p51 wi p71 p31 w pi pi http://sanneck.net/research/public/thesi/ sannoololoss.pdf. h. sanneck and g. carl. a queue manag algorithm for intracflow servic differenti in the best effort internet. in proceed of the eighth confer on comput commun and network (icccn), page 419426, natick, ma, octob 1999. ftp://ftp.foku.gmd.de/pub/glone/paper/sann9910: intra-flow.ps.gz. h. sanneck, n. le, and a. wolisz. effici qo support for voic-over-ip applic us select packet mark. in special session on error control techniqu for real-time deliveri of multimedia data, first intenz workshop on intellig multimedia comput (immcn), page 553-556, atlant citi, nj, februari 2000. ftp://ftp.foku.gmd.de/pub/glone/paper/sann0002: voip-mark.ps.gz. h. schulzrinn, j. kuros, and d. towslei. loss correl for queue with bursti input stream. in proceed icc, page 219-224, chicago, il, 1992. d. sisalem and a. wolisz. ldaf tcp-friendli adapt: a measur and comparison studi. in proceed nossdav, chapel hill, nc, june 2000. intern telecommun union. code of speech at 8 kbit/s us conjug-structur algebra-code-excit linear-predict (cs-acelp). recommend g.729, itu-t, march 1996. intern telecommun union. object oualitv measur of telephon-band (300-3400 hz) speech codec. recommend p.861, itu-t, februari 1998. m. yajnik, j. kuros, and d. towslei. packet loss correl in the mbone multicast network: experiment measur and markov chain model. technic report 95-115, depart of comput scienc, univers of massachusett, amherst, 1995. m. yajnik, s. moon, j. kuros, and d. towslei. measur and model of the tempor depend in packet loss. technic report 98-78, depart of comput scienc, univers of massachusett, amherst, 1998. w. yang and r. yantorno. improv of mbsd scale nois mask threshold and correl analysi with mo differ instead of mo. in proceed icassp, page 673-676, phoenix, az, march 1999. by 451 